<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Subir imagen</title>
  <!-- Cargar la librería exif.js para manejar metadatos de imagen -->
  <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    #preview-container {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 20px 0;
    }
    .preview-item {
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 5px;
      width: 200px;
    }
    .preview-image {
      width: 100%;
      height: auto;
      object-fit: cover;
    }
    .image-info {
      margin-top: 5px;
      font-size: 12px;
    }
    #result {
      white-space: pre-wrap;
      background: #f5f5f5;
      padding: 10px;
      border-radius: 5px;
      margin-top: 20px;
    }
    #uploadForm {
      margin-bottom: 20px;
    }
    button {
      padding: 10px 15px;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:disabled {
      background: #cccccc;
    }
    .loading {
      display: none;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>Subir imágenes</h1>
  <p>Las imágenes mayores a 1MB serán procesadas automáticamente para reducir su tamaño.</p>
  <form id="uploadForm" enctype="multipart/form-data" method="post" action="/upload">
    <input type="file" name="image" id="fileInput" accept="image/*" required multiple />
    <button type="submit" id="submitBtn">Subir Imágenes</button>
    <span class="loading" id="loading">Procesando...</span>
  </form>
  <div id="preview-container"></div>
  <div id="result"></div>
  <!-- Cargar el script de procesamiento de imágenes -->
  <!-- Cargar el script de procesamiento con ruta absoluta para evitar problemas -->
  <script src="/imgPerfil/imgSmall.js" onerror="console.error('Error cargando imgSmall.js')" defer></script>
  <script>
    // Variables globales
    const form = document.getElementById('uploadForm');
    const result = document.getElementById('result');
    const fileInput = document.getElementById('fileInput');
    const previewContainer = document.getElementById('preview-container');
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    
    // Verificar que las funciones de procesamiento están disponibles
    if (!window.compressImage || !window.toWebp) {
      console.warn('Las funciones de procesamiento de imágenes no están disponibles al iniciar.');
      result.innerHTML = '<div style="color: orange;">⚠️ Inicializando funciones de procesamiento de imágenes...</div>';
    }
    // Mostrar vistas previas
    fileInput.addEventListener('change', function() {
      const files = Array.from(this.files || []);
      previewContainer.innerHTML = '';
      if (files.length === 0) {
        return;
      }
      
      files.forEach(file => {
        if (!file.type.startsWith('image/')) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const item = document.createElement('div');
          item.className = 'preview-item';
          
          const img = document.createElement('img');
          img.className = 'preview-image';
          img.src = e.target.result;
          
          const info = document.createElement('div');
          info.className = 'image-info';
          const fileSize = file.size > 1024 * 1024 
            ? (file.size / (1024 * 1024)).toFixed(2) + ' MB' 
            : (file.size / 1024).toFixed(2) + ' KB';
          
          info.innerHTML = `${file.name}<br>${fileSize}`;
          
          // Todas las imágenes serán procesadas a webp
          info.innerHTML += '<br><span style="color: orange;">Será convertida a webp</span>';
          if (file.size > 1 * 1024 * 1024) {
            info.innerHTML += '<br><span style="color: orange;">Y reducida de tamaño</span>';
          }
          
          item.appendChild(img);
          item.appendChild(info);
          previewContainer.appendChild(item);
        };
        reader.readAsDataURL(file);
      });
    });

    // Función para formatear tamaños de archivo
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
      return (bytes / 1048576).toFixed(2) + ' MB';
    }
    
    // Esperar a que las funciones de procesamiento estén disponibles
    function waitForImageProcessing() {
      return new Promise((resolve) => {
        if (window.compressImage && window.toWebp) {
          resolve();
        } else {
          document.addEventListener('imgProcessingReady', () => resolve(), {once: true});
          // Timeout como fallback
          setTimeout(() => {
            console.warn('Timeout esperando funciones de procesamiento de imágenes');
            resolve();
          }, 3000);
        }
      });
    }
    
    // Procesar y subir imágenes
    async function processAndUpload(files) {
      result.innerHTML = '<strong>Procesando imágenes...</strong>\n';
      submitBtn.disabled = true;
      loading.style.display = 'inline';
      
      // Esperar a que las funciones estén disponibles
      await waitForImageProcessing();
      
      const formData = new FormData();
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        result.innerHTML += `<div>Procesando ${file.name}...</div>`;
        try {
          if (typeof window.compressImage !== 'function') {
            console.error('La función compressImage sigue sin estar disponible después de esperar');
            throw new Error('La función compressImage no está disponible');
          }
          
          // Siempre convertir/comprimir a webp, sin importar el tamaño
          const processed = await window.compressImage(file, 0.8, 1920, true);
          if (processed && processed.blob) {
            const newName = file.name.replace(/\.[^.]+$/, '.webp');
            formData.append('images', processed.blob, newName);
            result.innerHTML += `<div>${file.name} convertida a webp (${formatFileSize(processed.blob.size)}).</div>`;
          } else {
            // Marcar que no se pudo procesar en el cliente
            formData.append('images', file, file.name);
            formData.append('process_server', 'true'); // Indicar al servidor que procese esta imagen
            result.innerHTML += `<div>${file.name} no se pudo procesar en el navegador. El servidor la procesará.</div>`;
          }
        } catch (e) {
          console.error(`Error procesando ${file.name}:`, e);
          result.innerHTML += `<div style="color: red;">⚠️ Error procesando ${file.name}: ${e.message}. Se sube el archivo original.</div>`;
          formData.append('images', file, file.name);
        }
      }
      
      result.innerHTML += '<div><strong>Subiendo imágenes al servidor...</strong></div>';
      try {
        const res = await fetch('/upload', {
          method: 'POST',
          body: formData
        });
        const text = await res.text();
        if (res.ok) {
          // Parsear la respuesta JSON para mostrar los códigos únicos
          try {
            const jsonData = JSON.parse(text);
            result.innerHTML += `<div style="color: green;">✅ Subida completada</div>`;
            
            // Mostrar solo los IDs como códigos únicos
            const codigosHTML = jsonData.map(item => {
              if (item.error) {
                return `<div style="color: red;">❌ Error: ${item.error} - ${item.file}</div>`;
              }
              return `<div>Código único: <strong>${item.id}</strong></div>`;
            }).join('');
            
            result.innerHTML += codigosHTML;
          } catch (e) {
            result.innerHTML += `<div style="color: green;">✅ Subida completada</div>`;
            result.innerHTML += `<pre>${text}</pre>`;
          }
        } else {
          result.innerHTML += `<div style="color: red;">❌ Error: ${text}</div>`;
        }
      } catch (err) {
        result.innerHTML += `<div style="color: red;">❌ Error de red o servidor: ${err.message}</div>`;
      } finally {
        submitBtn.disabled = false;
        loading.style.display = 'none';
      }
    }
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const files = fileInput.files;
      if (!files.length) {
        result.innerHTML = '<div style="color: red;">Selecciona al menos una imagen.</div>';
        return;
      }
      previewContainer.innerHTML = '';
      await processAndUpload(files);
    });
  </script>
</body>
</html>
